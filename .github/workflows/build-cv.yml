name: Build CV PDF

on:
  push:
    paths:
      - "cv-src/**"
      - ".github/workflows/build-cv.yml"
    paths-ignore:
      - "files/cv.pdf"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Clean old LaTeX artifacts (in case any got committed before)
        run: |
          rm -f cv-src/*.aux cv-src/*.bbl cv-src/*.bcf cv-src/*.blg cv-src/*.fdb_latexmk cv-src/*.fls \
                cv-src/*.log cv-src/*.out cv-src/*.run.xml cv-src/*.toc cv-src/*.xdv cv-src/*.synctex.gz || true

      - name: Compile CV (XeLaTeX, TeXLive 2021, Debian)
        uses: xu-cheng/latex-action@v4
        with:
          working_directory: cv-src
          root_file: cv.tex
          latexmk_use_xelatex: true
          texlive_version: 2021
          os: debian
          extra_fonts: |
            ./cv-src/fonts/*.ttf
            ./cv-src/fonts/*.otf

      - name: Copy PDF into site
        run: |
          mkdir -p files
          cp cv-src/cv.pdf files/cv.pdf

      - name: Commit updated PDF
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update CV PDF [skip ci]"
          file_pattern: "files/cv.pdf"

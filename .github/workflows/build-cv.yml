name: Build CV PDF

on:
  push:
    branches:
      - master
      - main
    paths:
      - "cv-src/**"
      - ".github/workflows/build-cv.yml"
  workflow_dispatch:

concurrency:
  group: cv-pdf-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (full history so we can find last cv-src commit)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clean old LaTeX artifacts
        run: |
          rm -f cv-src/*.aux cv-src/*.bbl cv-src/*.bcf cv-src/*.blg cv-src/*.fdb_latexmk cv-src/*.fls \
                cv-src/*.log cv-src/*.out cv-src/*.run.xml cv-src/*.toc cv-src/*.xdv cv-src/*.synctex.gz || true

      - name: Compile CV (XeLaTeX, TeXLive 2021, Debian)
        uses: xu-cheng/latex-action@v4
        with:
          working_directory: cv-src
          root_file: cv.tex
          latexmk_use_xelatex: true
          texlive_version: 2021
          os: debian
          extra_fonts: |
            ./cv-src/fonts/*.ttf
            ./cv-src/fonts/*.otf

      - name: Copy PDF into site
        run: |
          mkdir -p files
          cp cv-src/cv.pdf files/cv.pdf

      - name: Write last-updated date (last commit touching cv-src)
        run: |
          mkdir -p _data
          echo "date: \"$(git log -1 --format=%cI -- cv-src)\"" > _data/cv_last_updated.yml
          echo "Wrote _data/cv_last_updated.yml:"
          cat _data/cv_last_updated.yml

      - name: Commit updated PDF + date
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # IMPORTANT: commit to the branch that Pages actually uses (master/main)
          branch: ${{ github.ref_name }}
          commit_message: "Update CV PDF [skip ci]"
          file_pattern: |
            files/cv.pdf
            _data/cv_last_updated.yml
